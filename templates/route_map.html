<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Route Map - Traffinity</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <style>
        :root {
            --charcoal-black: #1C1C1C;
            --traffic-red: #D7263D;
            --signal-yellow: #FFD23F;
            --green-light: #21BF73;
            --tech-gray: #E0E0E0;
            --glass-bg: rgba(224, 224, 224, 0.05);
            --glass-border: rgba(224, 224, 224, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--charcoal-black);
            color: var(--tech-gray);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            background: rgba(28, 28, 28, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            padding: 1.2rem 2rem;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 40px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-right {
            display: flex;
            align-items: center;
        }

        .header-divider {
            width: 1px;
            height: 24px;
            background: rgba(255, 255, 255, 0.2);
        }

        .back-btn {
            background: rgba(60, 60, 60, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(224, 224, 224, 0.8);
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .back-btn:hover {
            background: var(--signal-yellow);
            color: var(--charcoal-black);
            border-color: var(--signal-yellow);
            transform: translateX(-2px);
        }

        .header-title {
            color: var(--signal-yellow);
            font-weight: 600;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0;
        }

        .route-info {
            text-align: right;
            font-size: 0.9rem;
            background: rgba(60, 60, 60, 0.4);
            padding: 0.6rem 1rem;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 200px;
        }

        .loading-text {
            color: rgba(224, 224, 224, 0.7);
            font-weight: 500;
            opacity: 0.8;
        }

        /* Main Content */
        .main-content {
            padding-top: 80px;
            height: 100vh;
            display: flex;
        }

        /* Map Container */
        .map-container {
            flex: 1;
            position: relative;
            background: #2a2a2a;
        }

        #map {
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .map-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            padding: 2rem;
            color: var(--tech-gray);
            background: var(--glass-bg);
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(10px);
        }

        .map-placeholder i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        /* Sidebar */
        .sidebar {
            width: 350px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-left: 1px solid var(--glass-border);
            padding: 1.5rem;
            overflow-y: auto;
        }

        .sidebar-section {
            margin-bottom: 2rem;
        }

        .sidebar-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--signal-yellow);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .route-summary {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .route-summary.optimal {
            border-color: var(--green-light);
            background: rgba(33, 191, 115, 0.05);
        }

        .route-name {
            font-weight: 600;
            color: var(--tech-gray);
            margin-bottom: 0.5rem;
        }

        .route-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .optimal-badge {
            background: var(--green-light);
            color: var(--charcoal-black);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-left: 0.5rem;
        }

        /* Instructions */
        .instructions-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .instruction-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .instruction-icon {
            color: var(--signal-yellow);
            flex-shrink: 0;
            margin-top: 0.1rem;
        }

        .instruction-text {
            flex: 1;
            line-height: 1.4;
        }

        .instruction-distance {
            color: var(--tech-gray);
            opacity: 0.6;
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }

        /* Controls */
        .map-controls {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            z-index: 100;
        }

        .control-btn {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            color: var(--tech-gray);
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: var(--signal-yellow);
            color: var(--charcoal-black);
            border-color: var(--signal-yellow);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: 300px;
                border-left: none;
                border-top: 1px solid var(--glass-border);
            }

            .header {
                padding: 1rem;
            }

            .header-content {
                flex-direction: column;
                gap: 0.8rem;
                align-items: flex-start;
            }

            .header-left {
                width: 100%;
                justify-content: space-between;
            }

            .header-divider {
                display: none;
            }

            .header-title {
                font-size: 1.2rem;
            }

            .route-info {
                width: 100%;
                text-align: center;
                min-width: auto;
            }
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(224, 224, 224, 0.3);
            border-radius: 50%;
            border-top-color: var(--signal-yellow);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <a href="javascript:history.back()" class="back-btn">
                    ‚Üê Back
                </a>
                <div class="header-divider"></div>
                <h1 class="header-title">
                    üó∫Ô∏è Route Map
                </h1>
            </div>
            <div class="header-right">
                <div class="route-info" id="routeInfo">
                    <span class="loading-text">Loading route...</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Map Container -->
        <div class="map-container">
            <div id="map"></div>
            <div class="map-placeholder" id="mapPlaceholder" style="display: none;">
                üó∫Ô∏è
                <h3>Loading Route Data</h3>
                <p>Checking for route information...</p>
                <div class="loading"></div>
            </div>
            
            <!-- Map Controls -->
            <div class="map-controls">
                <button class="control-btn" title="Zoom In" onclick="zoomIn()">
                    +
                </button>
                <button class="control-btn" title="Zoom Out" onclick="zoomOut()">
                    -
                </button>
                <button class="control-btn" title="Reset View" onclick="resetView()">
                    üéØ
                </button>
                <button class="control-btn" title="My Location" onclick="showMyLocation()">
                    üìç
                </button>
            </div>
        </div>

        <!-- Sidebar -->
        <aside class="sidebar">
            <!-- Route Summary -->
            <div class="sidebar-section">
                <h2 class="sidebar-title">
                    
                    Route Summary
                </h2>
                <div id="routeSummary">
                    <div class="loading"></div>
                    Loading route details...
                </div>
            </div>

            <!-- Turn-by-Turn Instructions -->
            <div class="sidebar-section">
                <h2 class="sidebar-title">
                    
                    Directions
                </h2>
                <div id="instructions" class="instructions-list">
                    <div class="loading"></div>
                    Loading directions...
                </div>
            </div>

            <!-- Additional Info -->
            <div class="sidebar-section">
                <h2 class="sidebar-title">
                    
                    Route Info
                </h2>
                <div id="additionalInfo">
                    <div class="instruction-item">
                        
                        <div class="instruction-text">
                            Real-time traffic data
                            <div class="instruction-distance">Updated continuously</div>
                        </div>
                    </div>
                    <div class="instruction-item">
                        
                        <div class="instruction-text">
                            Weather-adjusted timing
                            <div class="instruction-distance">Accounts for conditions</div>
                        </div>
                    </div>
                    <div class="instruction-item">
                        
                        <div class="instruction-text">
                            Traffic incidents
                            <div class="instruction-distance">Live incident data</div>
                        </div>
                    </div>
                </div>
            </div>
        </aside>
    </main>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        // Global variables
        let map;
        let routeLayer;
        let markersLayer;
        
        // Get route ID from URL
        const routeId = window.location.pathname.split('/').pop();
        
        // Load route data on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            // Delay route data loading to allow map to initialize and wait for actual data
            setTimeout(() => {
                loadRouteData();
            }, 500);
        });
        
        function initializeMap() {
            try {
                // Show loading placeholder initially
                showMapPlaceholder();
                
                // Initialize the map with a neutral view (will be updated with actual data)
                map = L.map('map').setView([39.8283, -98.5795], 4); // Center of US, low zoom
                
                // Add OpenStreetMap tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);
                
                // Create layer groups for routes and markers
                routeLayer = L.layerGroup().addTo(map);
                markersLayer = L.layerGroup().addTo(map);
                
                console.log('Map initialized successfully, waiting for route data...');
                
            } catch (error) {
                console.error('Error initializing map:', error);
                showMapPlaceholder();
            }
        }
        
        function showMapPlaceholder() {
            document.getElementById('mapPlaceholder').style.display = 'block';
        }
        
        function hideMapPlaceholder() {
            document.getElementById('mapPlaceholder').style.display = 'none';
        }
        
        // Map control functions
        function zoomIn() {
            if (map) map.zoomIn();
        }
        
        function zoomOut() {
            if (map) map.zoomOut();
        }
        
        function resetView() {
            if (map && routeLayer.getLayers().length > 0) {
                map.fitBounds(routeLayer.getBounds());
            }
        }
        
        function showMyLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    if (map) {
                        map.setView([lat, lng], 15);
                        
                        // Add marker for current location
                        L.marker([lat, lng])
                            .addTo(markersLayer)
                            .bindPopup('üìç Your Location')
                            .openPopup();
                    }
                }, function(error) {
                    alert('Unable to get your location: ' + error.message);
                });
            } else {
                alert('Geolocation is not supported by this browser.');
            }
        }
        
        async function loadRouteData() {
            try {
                console.log('Loading route data...');
                
                // Get origin and destination from sessionStorage
                const origin = sessionStorage.getItem('origin');
                const destination = sessionStorage.getItem('destination');
                
                console.log('Origin:', origin, 'Destination:', destination);
                
                // Try to get route data from sessionStorage first
                const routeData = sessionStorage.getItem('routeData');
                const selectedRoute = sessionStorage.getItem('selectedRoute');
                
                if (routeData && origin && destination) {
                    console.log('Found route data in sessionStorage');
                    const routes = JSON.parse(routeData);
                    let targetRoute = null;
                    
                    if (selectedRoute) {
                        targetRoute = JSON.parse(selectedRoute);
                    } else {
                        // Find route by ID or use first route
                        targetRoute = routes[0];
                    }
                    
                    if (targetRoute) {
                        console.log('Displaying route:', targetRoute.name);
                        await displayRouteData(targetRoute, origin, destination);
                        return;
                    }
                }
                
                // If we have origin and destination, create a simple route
                if (origin && destination) {
                    console.log('Creating route from locations');
                    await displayRouteFromLocations(origin, destination);
                } else {
                    console.log('No route data found, showing no data message');
                    // Show message that no route data is available
                    displayNoRouteData();
                }
                
            } catch (error) {
                console.error('Error loading route data:', error);
                displayNoRouteData();
            }
        }
        
        async function displayRouteFromLocations(origin, destination) {
            try {
                console.log('Getting route from', origin, 'to', destination);
                
                if (!origin || !destination) {
                    throw new Error('Origin and destination are required');
                }
                
                // Geocode origin and destination
                console.log('Geocoding origin:', origin);
                const originCoords = await geocodeLocation(origin);
                
                if (!originCoords) {
                    throw new Error(`Could not find coordinates for origin: "${origin}"`);
                }
                
                console.log('Geocoding destination:', destination);
                const destCoords = await geocodeLocation(destination);
                
                if (!destCoords) {
                    throw new Error(`Could not find coordinates for destination: "${destination}"`);
                }
                
                console.log('Both coordinates found:', { origin: originCoords, destination: destCoords });
                
                // Try to get proper routing with directions
                const routeData = await getRoutingDirections(originCoords, destCoords);
                
                if (routeData && routeData.coordinates) {
                    console.log('Route data found, displaying actual route');
                    displayActualRoute(routeData, origin, destination);
                } else {
                    console.log('No route data found, displaying straight line route');
                    displayStraightLineRoute(originCoords, destCoords, origin, destination);
                }
                
                hideMapPlaceholder();
                
            } catch (error) {
                console.error('Error creating route from locations:', error);
                
                // Show specific error message to user
                const mapContainer = document.getElementById('map');
                if (mapContainer) {
                    mapContainer.innerHTML = `
                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; background: var(--glass-bg); border-radius: 12px; text-align: center; padding: 2rem;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üó∫Ô∏è</div>
                            <h3 style="color: var(--traffic-red); margin-bottom: 0.5rem;">Map Error</h3>
                            <p style="color: var(--tech-gray); margin-bottom: 1rem;">${error.message}</p>
                            <p style="color: var(--tech-gray); opacity: 0.7; font-size: 0.9rem;">Please check the location names and try again</p>
                        </div>
                    `;
                }
                
                hideMapPlaceholder();
            }
        }
        
        async function getRoutingDirections(originCoords, destCoords) {
            try {
                // Use OSRM (Open Source Routing Machine) for free routing
                const url = `https://router.project-osrm.org/route/v1/driving/${originCoords[1]},${originCoords[0]};${destCoords[1]},${destCoords[0]}?overview=full&geometries=geojson&steps=true`;
                
                console.log('Fetching routing data from OSRM...');
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.code === 'Ok' && data.routes && data.routes.length > 0) {
                    const route = data.routes[0];
                    console.log('Got routing data:', route);
                    
                    const distance = route.distance / 1000; // Convert to km
                    const fuel = calculateFuelConsumption(distance);
                    
                    return {
                        coordinates: route.geometry.coordinates.map(coord => [coord[1], coord[0]]), // Swap lng,lat to lat,lng
                        distance: distance,
                        duration: route.duration / 60, // Convert to minutes
                        steps: route.legs[0]?.steps || [],
                        fuel_consumption: fuel.liters,
                        fuel_cost: fuel.cost
                    };
                }
                
                return null;
            } catch (error) {
                console.error('Error getting routing directions:', error);
                return null;
            }
        }
        
        function displayActualRoute(routeData, origin, destination) {
            // Clear existing layers
            routeLayer.clearLayers();
            markersLayer.clearLayers();
            
            // Add markers for origin and destination
            const originMarker = L.marker(routeData.coordinates[0])
                .addTo(markersLayer)
                .bindPopup(`üöÄ Start: ${origin}`);
            
            const destMarker = L.marker(routeData.coordinates[routeData.coordinates.length - 1])
                .addTo(markersLayer)
                .bindPopup(`üéØ Destination: ${destination}`);
            
            // Create the routed polyline
            const routeLine = L.polyline(routeData.coordinates, {
                color: '#21BF73',
                weight: 5,
                opacity: 0.8
            }).addTo(routeLayer);
            
            // Fit map to show the route
            const group = new L.featureGroup([originMarker, destMarker, routeLine]);
            map.fitBounds(group.getBounds().pad(0.1));
            
            // Display route information with directions
            displayRouteInfoWithDirections({
                name: `${origin} to ${destination}`,
                distance: routeData.distance,
                duration: routeData.duration,
                origin: origin,
                destination: destination,
                steps: routeData.steps
            });
        }
        
        function displayStraightLineRoute(originCoords, destCoords, origin, destination) {
            // Clear existing layers
            routeLayer.clearLayers();
            markersLayer.clearLayers();
            
            // Add markers for origin and destination
            const originMarker = L.marker(originCoords)
                .addTo(markersLayer)
                .bindPopup(`üöÄ Start: ${origin}`);
            
            const destMarker = L.marker(destCoords)
                .addTo(markersLayer)
                .bindPopup(`üéØ Destination: ${destination}`);
            
            // Create a simple polyline between points
            const routeLine = L.polyline([originCoords, destCoords], {
                color: '#FFD23F',
                weight: 4,
                opacity: 0.7,
                dashArray: '10, 10'
            }).addTo(routeLayer);
            
            // Fit map to show the route
            const group = new L.featureGroup([originMarker, destMarker, routeLine]);
            map.fitBounds(group.getBounds().pad(0.1));
            
            // Display route information
            const distance = calculateDistance(originCoords, destCoords);
            const estimatedTime = Math.round(distance * 2); // Rough estimate: 2 minutes per km
            
            displayRouteInfo({
                name: `Direct Route: ${origin} to ${destination}`,
                distance: distance,
                duration: estimatedTime,
                origin: origin,
                destination: destination
            });
        }
        
        async function geocodeLocation(location) {
            try {
                console.log('Geocoding location:', location);
                
                // Use our existing Flask geocoding endpoint that uses TomTom API
                const response = await fetch('/geocode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ location: location })
                });
                
                if (!response.ok) {
                    throw new Error(`Geocoding API returned ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data && data.lat && data.lon) {
                    console.log('Geocoding successful:', data);
                    return [parseFloat(data.lat), parseFloat(data.lon)];
                }
                
                console.log('No coordinates found for location:', location);
                return null;
            } catch (error) {
                console.error('Geocoding error for location "' + location + '":', error);
                
                // Fallback to Nominatim as backup
                try {
                    console.log('Trying fallback geocoding with Nominatim...');
                    const fallbackResponse = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}&limit=1`);
                    const fallbackData = await fallbackResponse.json();
                    
                    if (fallbackData && fallbackData.length > 0) {
                        console.log('Fallback geocoding successful');
                        return [parseFloat(fallbackData[0].lat), parseFloat(fallbackData[0].lon)];
                    }
                } catch (fallbackError) {
                    console.error('Fallback geocoding also failed:', fallbackError);
                }
                
                return null;
            }
        }
        
        function calculateDistance(coord1, coord2) {
            const R = 6371; // Radius of Earth in km
            const dLat = (coord2[0] - coord1[0]) * Math.PI / 180;
            const dLon = (coord2[1] - coord1[1]) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(coord1[0] * Math.PI / 180) * Math.cos(coord2[0] * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c; // Distance in km
        }
        
        async function displayRouteData(route, origin, destination) {
            displayRouteInfo(route);
            
            // If we have coordinates in the route data, display them on map
            if (route.coordinates && route.coordinates.length > 0) {
                displayRouteOnMap(route.coordinates, route.name);
            } else if (origin && destination) {
                // Try to create route from origin and destination
                try {
                    await displayRouteFromLocations(origin, destination);
                } catch (error) {
                    console.error('Error displaying route from locations:', error);
                }
            }
        }
        
        function calculateFuelConsumption(distance, vehicleType = 'car') {
            // Average fuel consumption rates (L/100km) for different vehicle types
            const fuelRates = {
                'car': 7.5,        // Average car: 7.5L/100km
                'suv': 9.5,        // SUV: 9.5L/100km
                'truck': 12.0,     // Truck: 12L/100km
                'motorcycle': 4.5, // Motorcycle: 4.5L/100km
                'hybrid': 5.0,     // Hybrid car: 5L/100km
                'electric': 0      // Electric vehicle: 0L (could show kWh instead)
            };
            
            const rate = fuelRates[vehicleType] || fuelRates['car'];
            const consumption = (distance * rate) / 100;
            
            return {
                liters: consumption,
                cost: consumption * 1.45 // Average petrol price per liter (‚Çπ145/L in India)
            };
        }
        
        function displayRouteInfo(route) {
            // Update header info
            const duration = route.duration || route.weather_adjusted_duration || 0;
            document.getElementById('routeInfo').textContent = `${route.name} ‚Ä¢ ${formatDuration(duration)}`;
            
            // Display route summary
            const summaryHTML = `
                <div class="route-summary optimal">
                    <div class="route-name">
                        ${route.name}
                        <span class="optimal-badge">Live Route</span>
                    </div>
                    <div class="route-stats">
                        <div class="stat-item">
                            ‚è±Ô∏è
                            ${formatDuration(duration)}
                        </div>
                        <div class="stat-item">
                            üìè
                            ${(route.distance || 0).toFixed(1)} km
                        </div>
                        <div class="stat-item">
                            ‚õΩ
                            ${(() => {
                                const distance = route.distance || 0;
                                const fuel = calculateFuelConsumption(distance);
                                return fuel.liters.toFixed(1) + 'L (~‚Çπ' + Math.round(fuel.cost) + ')';
                            })()}
                        </div>
                        <div class="stat-item">
                            üö¶
                            ${formatDuration(route.traffic_delay || 0)} delay
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('routeSummary').innerHTML = summaryHTML;
            
            // Display basic instructions
            document.getElementById('instructions').innerHTML = `
                <div class="instruction-item">
                    ‚ÑπÔ∏è
                    <div class="instruction-text">
                        Route displayed on map. For detailed turn-by-turn directions, use navigation apps.
                    </div>
                </div>
            `;
        }
        
        function displayRouteInfoWithDirections(route) {
            // Update header info
            document.getElementById('routeInfo').textContent = `${route.name} ‚Ä¢ ${formatDuration(route.duration)}`;
            
            // Display route summary
            const summaryHTML = `
                <div class="route-summary optimal">
                    <div class="route-name">
                        ${route.name}
                        <span class="optimal-badge">Live Route</span>
                    </div>
                    <div class="route-stats">
                        <div class="stat-item">
                            ‚è±Ô∏è
                            ${formatDuration(route.duration)}
                        </div>
                        <div class="stat-item">
                            üìè
                            ${route.distance.toFixed(1)} km
                        </div>
                        <div class="stat-item">
                            ‚õΩ
                            Est. ${(route.distance * 0.08).toFixed(1)}L
                        </div>
                        <div class="stat-item">
                            üö¶
                            Live traffic
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('routeSummary').innerHTML = summaryHTML;
            
            // Display turn-by-turn directions
            if (route.steps && route.steps.length > 0) {
                const instructionsHTML = route.steps.map((step, index) => {
                    const instruction = step.maneuver?.instruction || step.instruction || `Continue for ${(step.distance/1000).toFixed(1)} km`;
                    const distance = step.distance ? `${(step.distance/1000).toFixed(1)} km` : '';
                    const icon = getDirectionIcon(step.maneuver?.type);
                    
                    return `
                        <div class="instruction-item">
                            ${icon}
                            <div class="instruction-text">
                                ${instruction}
                                ${distance ? `<div class="instruction-distance">${distance}</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('instructions').innerHTML = instructionsHTML;
            } else {
                document.getElementById('instructions').innerHTML = `
                    <div class="instruction-item">
                        üß≠
                        <div class="instruction-text">
                            Head from ${route.origin} to ${route.destination}
                            <div class="instruction-distance">Total: ${route.distance.toFixed(1)} km</div>
                        </div>
                    </div>
                `;
            }
        }
        
        function getDirectionIcon(maneuverType) {
            const icons = {
                'depart': 'üöÄ',
                'arrive': 'üéØ',
                'turn': '‚Ü©Ô∏è',
                'new name': 'üìç',
                'continue': '‚¨ÜÔ∏è',
                'merge': 'üîÄ',
                'on ramp': 'üîÑ',
                'off ramp': '‚ÜóÔ∏è',
                'fork': 'üî±',
                'end of road': '‚ö†Ô∏è',
                'use lane': 'üõ£Ô∏è',
                'roundabout': 'üîÑ'
            };
            return icons[maneuverType] || 'üß≠';
        }
        
        function displayRouteOnMap(coordinates, routeName) {
            try {
                // Clear existing layers
                routeLayer.clearLayers();
                markersLayer.clearLayers();
                
                // Convert coordinates to Leaflet format if needed
                const latLngs = coordinates.map(coord => [coord.lat || coord[0], coord.lng || coord[1]]);
                
                // Create route polyline
                const routeLine = L.polyline(latLngs, {
                    color: '#21BF73',
                    weight: 4,
                    opacity: 0.8
                }).addTo(routeLayer);
                
                // Add start and end markers
                if (latLngs.length > 0) {
                    L.marker(latLngs[0])
                        .addTo(markersLayer)
                        .bindPopup('üöÄ Start');
                    
                    L.marker(latLngs[latLngs.length - 1])
                        .addTo(markersLayer)
                        .bindPopup('üéØ Destination');
                }
                
                // Fit map to route
                map.fitBounds(routeLine.getBounds().pad(0.1));
                
            } catch (error) {
                console.error('Error displaying route on map:', error);
            }
        }
        
        function displayNoRouteData() {
            console.log('No route data available');
            
            // Hide map placeholder and show no data message
            hideMapPlaceholder();
            
            // Update header to show no route available
            document.getElementById('routeInfo').innerHTML = `
                <span style="color: var(--traffic-red);">‚ö†Ô∏è No Route Data</span>
                <br><small>Return to main page and analyze a route first</small>
            `;
            
            // Display no data message in route summary
            const noDataHTML = `
                <div class="route-summary" style="border-color: var(--traffic-red); background: rgba(215, 38, 61, 0.1);">
                    <div class="route-name" style="color: var(--traffic-red);">
                        No Route Available
                        <span class="optimal-badge" style="background: var(--traffic-red);">Missing Data</span>
                    </div>
                    <div style="margin-top: 15px; padding: 15px; background: var(--glass-bg); border-radius: 8px;">
                        <p style="color: var(--tech-gray); margin-bottom: 10px;">To view a route on the map:</p>
                        <ol style="color: rgba(224, 224, 224, 0.8); padding-left: 20px;">
                            <li>Go back to the main page</li>
                            <li>Enter your origin and destination</li>
                            <li>Click "Analyze Traffic & Routes"</li>
                            <li>Click "üó∫Ô∏è View on Map" for any route</li>
                        </ol>
                    </div>
                </div>
            `;
            
            document.getElementById('routeSummary').innerHTML = noDataHTML;
            
            // Display instructions for getting route data
            const instructionsHTML = `
                <div class="instruction-item">
                    ‚ùì
                    <div class="instruction-text">
                        No route instructions available
                        <div class="instruction-distance">Analyze a route first to see directions</div>
                    </div>
                </div>
                <div class="instruction-item">
                    üè†
                    <div class="instruction-text">
                        Return to main page
                        <div class="instruction-distance">Enter locations and analyze traffic</div>
                    </div>
                </div>
                <div class="instruction-item">
                    üó∫Ô∏è
                    <div class="instruction-text">
                        Click "View on Map" from results
                        <div class="instruction-distance">Opens route visualization here</div>
                    </div>
                </div>
            `;
            
            document.getElementById('instructions').innerHTML = instructionsHTML;
            
            // Show empty map with no specific location
            if (map) {
                // Reset to world view
                map.setView([20, 0], 2);
            }
        }
        
        function formatDuration(durationMinutes) {
            const totalSeconds = Math.round(durationMinutes * 60);
            const totalMinutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            
            if (totalMinutes >= 60) {
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                if (minutes === 0) {
                    return `${hours}h`;
                } else {
                    return `${hours}h ${minutes}m`;
                }
            } else {
                return `${totalMinutes}m`;
            }
        }
    </script>
</body>
</html>
